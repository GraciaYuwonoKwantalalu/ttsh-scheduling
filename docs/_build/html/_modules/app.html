

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>app &mdash; Rostering Scheduling for Healthcare Professionals  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Rostering Scheduling for Healthcare Professionals
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Web Application</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Rostering Scheduling for Healthcare Professionals</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>app</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for app</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">holidays</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">helperFunctions</span> <span class="kn">import</span> <span class="n">create_connection</span><span class="p">,</span> <span class="n">close_connection</span><span class="p">,</span> <span class="n">check_weekend</span><span class="p">,</span> <span class="n">check_day</span><span class="p">,</span> <span class="n">check_month_num</span><span class="p">,</span> <span class="n">check_eveph</span><span class="p">,</span> <span class="n">is_constraint_met</span><span class="p">,</span> <span class="n">readRoster</span><span class="p">,</span> <span class="n">readDuties</span><span class="p">,</span> <span class="n">readtraining</span><span class="p">,</span> <span class="n">readpleave</span><span class="p">,</span> <span class="n">readCallRequest</span><span class="p">,</span> <span class="n">readPh</span><span class="p">,</span> <span class="n">clashes</span><span class="p">,</span> <span class="n">exportScheduleS</span><span class="p">,</span> <span class="n">exportScheduleJ</span><span class="p">,</span> <span class="n">email_json</span><span class="p">,</span> <span class="n">produce_doctor_dictionary</span>
<span class="kn">from</span> <span class="nn">lpFunction</span> <span class="kn">import</span> <span class="n">run_lp</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">win32com.client</span> <span class="k">as</span> <span class="nn">win32</span>
<span class="kn">from</span> <span class="nn">win32com</span> <span class="kn">import</span> <span class="n">client</span>
<span class="kn">import</span> <span class="nn">win32api</span>
<span class="kn">import</span> <span class="nn">pythoncom</span>
<span class="kn">import</span> <span class="nn">xlsxwriter</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="c1"># Initialize Flask app</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span>

<span class="c1">### WEB PAGES ###</span>
<div class="viewcode-block" id="home"><a class="viewcode-back" href="../app.html#app.home">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redirects to **Home** page (home.html).</span>

<span class="sd">    :parameters: *retrieve_constraints()* </span>
<span class="sd">    :return: dictionary of constraints name &amp; constraints value.</span>
<span class="sd">    For example: *{&quot;P&quot;: 3, &quot;amSat_clinic_1&quot;: 1, &quot;amSat_clinic_3&quot;: 1}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">retrieve_constraints</span><span class="p">()</span>
    <span class="n">constraints_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;doctor_call_daily&quot;</span><span class="p">:</span><span class="s2">&quot;No. of doctors on call daily&quot;</span><span class="p">,</span> <span class="s2">&quot;day_off_monthly&quot;</span><span class="p">:</span><span class="s2">&quot;Min no. of days off in 4 weeks&quot;</span><span class="p">,</span> <span class="s2">&quot;max_call_month_4&quot;</span><span class="p">:</span><span class="s2">&quot;Max no. of calls in 4-week month&quot;</span><span class="p">,</span> <span class="s2">&quot;max_call_month_5&quot;</span><span class="p">:</span><span class="s2">&quot;Max no. of calls in 5-week month&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;total_call&quot;</span><span class="p">:</span><span class="s2">&quot;No. of calls and call requests&quot;</span><span class="p">,</span> <span class="s2">&quot;clinic_1&quot;</span><span class="p">:</span><span class="s2">&quot;No. of doctors on duty in clinic 1&quot;</span><span class="p">,</span> <span class="s2">&quot;clinic_2&quot;</span><span class="p">:</span><span class="s2">&quot;No. of doctors on duty in clinic 2&quot;</span><span class="p">,</span> <span class="s2">&quot;amSat_clinic_1&quot;</span><span class="p">:</span><span class="s2">&quot;No. of doctors on duty in amSat clinic 1&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;amSat_clinic_3&quot;</span><span class="p">:</span><span class="s2">&quot;No. of doctors on duty in amSat clinic 3&quot;</span><span class="p">,</span> <span class="s2">&quot;amSat_clinic_4&quot;</span><span class="p">:</span><span class="s2">&quot;No. of doctors on duty in amSat clinic 4&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span><span class="s2">&quot;No. of doctors on duty in P&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;home.html&quot;</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span> <span class="n">constraints_name</span><span class="o">=</span><span class="n">constraints_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="timetable"><a class="viewcode-back" href="../app.html#app.timetable">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/timetable&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">timetable</span><span class="p">():</span>    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redirects to **Timetable** page (timetable.html).</span>

<span class="sd">    :parameters: *retrieve_timetable()* </span>
<span class="sd">    :return: nested dictionary containing status, doctor, date, type and remarks generated by the LP. </span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;S&quot;: {&quot;Dr Lee&quot;: {&quot;01-05-2021 Saturday&quot;: {&quot;Off&quot;: &quot;&quot;}}}, &quot;J&quot;: {&quot;Dr Ho&quot;: {&quot;01-05-2021 Saturday&quot;: {&quot;Duty&quot;: &quot;ICU 1&quot;}}}}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timetable_dict</span> <span class="o">=</span> <span class="n">retrieve_timetable</span><span class="p">()</span>

    <span class="n">innerKey2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">timetable_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">innerValue2</span> <span class="o">=</span> <span class="n">timetable_dict</span><span class="p">[</span><span class="n">innerKey2</span><span class="p">]</span>
    <span class="n">innerKey3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">innerValue2</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">innerValue3</span> <span class="o">=</span> <span class="n">innerValue2</span><span class="p">[</span><span class="n">innerKey3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;timetable.html&quot;</span><span class="p">,</span> <span class="n">timetable_dict</span><span class="o">=</span><span class="n">timetable_dict</span><span class="p">,</span> <span class="n">innerValue3</span><span class="o">=</span><span class="n">innerValue3</span><span class="p">)</span></div>

<div class="viewcode-block" id="past_timetable"><a class="viewcode-back" href="../app.html#app.past_timetable">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/past_timetable&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">past_timetable</span><span class="p">():</span>    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redirects to **Past Timetable** page (past_timetable.html).</span>

<span class="sd">    :parameters: *scheduleJ.xlsx* and *scheduleS.xlsx* </span>
<span class="sd">    :return: nested dictionary containing status, doctor, date, type and remarks extracted from the excel files.</span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;S&quot;: {&quot;Dr Lee&quot;: {&quot;01-05-2021 Saturday&quot;: {&quot;Off&quot;: &quot;&quot;}}}, &quot;J&quot;: {&quot;Dr Ho&quot;: {&quot;01-05-2021 Saturday&quot;: {&quot;Duty&quot;: &quot;ICU 1&quot;}}}}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Reading from Senior Doctor file</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;scheduleS.xlsx&#39;</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;SeniorSchedule&#39;</span><span class="p">)</span>
    
    <span class="n">index1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span>
    <span class="n">number_of_rows1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index1</span><span class="p">)</span>

    <span class="c1"># Get the senior doctor names in 1 list</span>
    <span class="n">senior_doc_name</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">senior_doc_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">senior_doc_name</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">senior_doc_name</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Obtain the senior doctor dictionary</span>
    <span class="n">senior_doc_dict</span> <span class="o">=</span> <span class="n">produce_doctor_dictionary</span><span class="p">(</span><span class="n">senior_doc_name</span><span class="p">,</span><span class="n">number_of_rows1</span><span class="p">,</span><span class="n">df1</span><span class="p">)</span>
    
    <span class="c1"># Reading from Junior Doctor file</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;scheduleJ.xlsx&#39;</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;JuniorSchedule&#39;</span><span class="p">)</span>

    <span class="n">index2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span>
    <span class="n">number_of_rows2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index2</span><span class="p">)</span>

    <span class="c1"># Get the junior doctor names in 1 list</span>
    <span class="n">junior_doc_name</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">junior_doc_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">junior_doc_name</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">junior_doc_name</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Obtain the junior doctor dictionary</span>
    <span class="n">junior_doc_dict</span> <span class="o">=</span> <span class="n">produce_doctor_dictionary</span><span class="p">(</span><span class="n">junior_doc_name</span><span class="p">,</span><span class="n">number_of_rows2</span><span class="p">,</span><span class="n">df2</span><span class="p">)</span>

    <span class="c1"># Put everything in format for front-end: {&#39;S&#39;: senior_doc_dict, &#39;J&#39;: junior_doc_dict}      </span>
    <span class="n">timetable_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">senior_doc_dict</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="n">junior_doc_dict</span><span class="p">}</span>

    <span class="n">innerKey2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">timetable_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">innerValue2</span> <span class="o">=</span> <span class="n">timetable_dict</span><span class="p">[</span><span class="n">innerKey2</span><span class="p">]</span>
    <span class="n">innerKey3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">innerValue2</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">innerValue3</span> <span class="o">=</span> <span class="n">innerValue2</span><span class="p">[</span><span class="n">innerKey3</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;past_timetable.html&quot;</span><span class="p">,</span> <span class="n">timetable_dict</span><span class="o">=</span><span class="n">timetable_dict</span><span class="p">,</span> <span class="n">innerValue3</span><span class="o">=</span><span class="n">innerValue3</span><span class="p">)</span></div>

<div class="viewcode-block" id="summary"><a class="viewcode-back" href="../app.html#app.summary">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/summary&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">summary</span><span class="p">():</span>    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redirects to **Summary** page (summary.html).</span>

<span class="sd">    :parameters: *retrieve_call_summary()* </span>
<span class="sd">    :return: nested dictionary containing date, summary name and summary value.</span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;01-05-2021 Saturday&quot;: {&quot;P&quot;: 0,&quot;amSat Clinic 1&quot;: 0,&quot;amSat Clinic 3&quot;: 0}}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">call_summary_dict</span> <span class="o">=</span> <span class="n">retrieve_call_summary</span><span class="p">()</span>
    <span class="n">call_summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">call_summary_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;summary.html&quot;</span><span class="p">,</span> <span class="n">call_summary_dict</span><span class="o">=</span><span class="n">call_summary_dict</span><span class="p">,</span> <span class="n">call_summary_tables</span><span class="o">=</span><span class="p">[</span><span class="n">call_summary_df</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)])</span></div>

<div class="viewcode-block" id="icu_duties"><a class="viewcode-back" href="../app.html#app.icu_duties">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/icu_duties&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">icu_duties</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redirects to **ICU Duties** page (icu_duties.html).</span>

<span class="sd">    :parameters: *retrieve_icu_1_table()* and *retrieve_icu_2_table()*</span>
<span class="sd">    :return: dictionary containing date and doctor.</span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;01-05-2021 Saturday&quot;: &quot;Dr Lee&quot;, &quot;02-05-2021 Sunday&quot;: &quot;Dr Ho&quot;}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">icu1</span> <span class="o">=</span> <span class="n">retrieve_icu_1_table</span><span class="p">()</span>
    <span class="n">icu2</span> <span class="o">=</span> <span class="n">retrieve_icu_2_table</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;icu_duties.html&quot;</span><span class="p">,</span> <span class="n">icu1</span><span class="o">=</span><span class="n">icu1</span><span class="p">,</span> <span class="n">icu2</span><span class="o">=</span><span class="n">icu2</span><span class="p">)</span></div>

<div class="viewcode-block" id="points"><a class="viewcode-back" href="../app.html#app.points">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/points&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">points</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redirects to **Points** page (points.html).</span>

<span class="sd">    :parameters: *retrieve_points_summary()*</span>
<span class="sd">    :return: nested dictionary containing status, doctor, points name and points value.</span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;S&quot;:{&quot;Dr Lee&quot;:{&quot;Clinic 1&quot;:0, &quot;Clinic 2&quot;:0, &quot;Clinic 3&quot;:0}}, &quot;J&quot;:{&quot;Dr Ho&quot;:{&quot;Clinic 1&quot;:0, &quot;Clinic 2&quot;:0, &quot;Clinic 3&quot;:0}}}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">overall_summary</span> <span class="o">=</span> <span class="n">retrieve_points_summary</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;points.html&quot;</span><span class="p">,</span> <span class="n">overall_summary</span><span class="o">=</span><span class="n">overall_summary</span><span class="p">)</span></div>

<span class="c1">### DOWNLOAD ###</span>
<div class="viewcode-block" id="download_timetable"><a class="viewcode-back" href="../app.html#app.download_timetable">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/download_pdf&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_timetable</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports timetable as PDF.</span>

<span class="sd">    :parameters: timetable data from *TempJ* and *TempS* tables</span>
<span class="sd">    :return: *timetable_senior.pdf* and *timetable_junior.pdf*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="c1">### Junior</span>
    <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM TempJ;&quot;&quot;&quot;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
    <span class="n">dataJ</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">data_new2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dataJ</span><span class="p">:</span>
        <span class="n">myTuple</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">data_new_tuple2</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">j1</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">j1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">j1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">j1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j1</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># remove the comments</span>
            <span class="n">remark_wo_comment</span> <span class="o">=</span> <span class="n">j1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">remark_wo_comment</span> <span class="o">=</span> <span class="n">remark_wo_comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">myResult</span> <span class="o">=</span> <span class="n">j1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">remark_wo_comment</span>

            <span class="n">data_new_tuple2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myResult</span><span class="p">)</span>
        
        <span class="n">data_new2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_new_tuple2</span><span class="p">)</span>
        
        <span class="n">data_new_tuple2</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data_new2</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="c1"># df = df.T</span>
    
    <span class="n">number_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">&#39;timetable_junior.xlsx&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;junior&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Doctor&#39;</span><span class="p">]</span>
    
    <span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
    <span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s1">&#39;junior&#39;</span><span class="p">]</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">repeat_columns</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># set column width</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:XFD&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    
    <span class="c1"># Define our range for the color formatting</span>
    <span class="n">format1</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#9FEDD7&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    <span class="n">format2</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FBE8A6&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    <span class="n">format3</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FCE181&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    <span class="n">format4</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#D3E3FC&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    <span class="n">format5</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FEF9C7&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    
    <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;Duty&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format1</span><span class="p">})</span>
                                            
    <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;On-Leave&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format2</span><span class="p">})</span>
                                            
    <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;Working&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format3</span><span class="p">})</span>
                                            
    <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;On-Call&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format4</span><span class="p">})</span>
                                            
    <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;Off&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format5</span><span class="p">})</span>           
                                               
    <span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
    <span class="n">print_excel_worksheet_to_pdf</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">timetable_junior.xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;junior&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">timetable_junior.pdf&#39;</span><span class="p">)</span>
    
    <span class="c1">### Senior</span>
    <span class="n">script1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM TempS;&quot;&quot;&quot;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">script1</span><span class="p">)</span>
    <span class="n">columnsS</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
    <span class="n">dataS</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">data_new1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dataS</span><span class="p">:</span>
        <span class="n">myTuple</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">data_new_tuple2</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
      
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">j1</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">j1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">j1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">j1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j1</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># remove the comments</span>
            <span class="n">remark_wo_comment</span> <span class="o">=</span> <span class="n">j1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">remark_wo_comment</span> <span class="o">=</span> <span class="n">remark_wo_comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">myResult</span> <span class="o">=</span> <span class="n">j1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">remark_wo_comment</span>

            <span class="n">data_new_tuple2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myResult</span><span class="p">)</span>
        
        <span class="n">data_new1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_new_tuple2</span><span class="p">)</span>
        
        <span class="n">data_new_tuple2</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data_new1</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">columnsS</span><span class="p">)</span>
    <span class="c1"># df2 = df2.T</span>
    <span class="n">number_rows2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="n">writer2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">&#39;timetable_senior.xlsx&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
    <span class="n">df2</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;senior&#39;</span><span class="p">)</span>
    <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Doctor&#39;</span><span class="p">]</span>
    
    <span class="n">workbook2</span> <span class="o">=</span> <span class="n">writer2</span><span class="o">.</span><span class="n">book</span>
    <span class="n">worksheet2</span> <span class="o">=</span> <span class="n">writer2</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s1">&#39;senior&#39;</span><span class="p">]</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">repeat_columns</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># set column width</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:XFD&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    
    <span class="c1"># Define our range for the color formatting</span>
    <span class="n">format1</span> <span class="o">=</span> <span class="n">workbook2</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#9FEDD7&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    <span class="n">format2</span> <span class="o">=</span> <span class="n">workbook2</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FBE8A6&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    <span class="n">format3</span> <span class="o">=</span> <span class="n">workbook2</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FCE181&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    <span class="n">format4</span> <span class="o">=</span> <span class="n">workbook2</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#D3E3FC&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    <span class="n">format5</span> <span class="o">=</span> <span class="n">workbook2</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FEF9C7&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2E282E&#39;</span><span class="p">})</span>
    
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;Duty&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format1</span><span class="p">})</span>
                                            
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;On-Leave&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format2</span><span class="p">})</span>
                                            
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;Working&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format3</span><span class="p">})</span>
                                            
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;On-Call&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format4</span><span class="p">})</span>
                                            
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="s1">&#39;A2:XFD1048576&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span>     <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;value&#39;</span><span class="p">:</span>    <span class="s1">&#39;Off&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;format&#39;</span><span class="p">:</span>   <span class="n">format5</span><span class="p">})</span>
                                           
                                               
    <span class="n">writer2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
    <span class="n">print_excel_worksheet_to_pdf</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">timetable_senior.xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;senior&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">timetable_senior.pdf&#39;</span><span class="p">)</span>
    
    <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;timetable&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="print_excel_worksheet_to_pdf"><a class="viewcode-back" href="../app.html#app.print_excel_worksheet_to_pdf">[docs]</a><span class="k">def</span> <span class="nf">print_excel_worksheet_to_pdf</span><span class="p">(</span><span class="n">i_sz_excel_path</span><span class="p">,</span> <span class="n">i_sz_ws_name</span><span class="p">,</span> <span class="n">i_sz_pdf_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aids the other download PDF functions by converting CSV to landscape PDF. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pythoncom</span><span class="o">.</span><span class="n">CoInitialize</span><span class="p">()</span>
    <span class="n">excel</span> <span class="o">=</span> <span class="n">win32</span><span class="o">.</span><span class="n">gencache</span><span class="o">.</span><span class="n">EnsureDispatch</span><span class="p">(</span><span class="s1">&#39;Excel.Application&#39;</span><span class="p">)</span>
    <span class="n">pythoncom</span><span class="o">.</span><span class="n">CoInitialize</span><span class="p">()</span>
    
    <span class="n">excel</span><span class="o">.</span><span class="n">Visible</span> <span class="o">=</span> <span class="kc">False</span>   <span class="c1">#Keep the excel sheet closed</span>
    <span class="n">excel</span><span class="o">.</span><span class="n">DisplayAlerts</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#&quot;Do you want to over write it?&quot; Will not Pop up</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">wb_source</span> <span class="o">=</span> <span class="n">excel</span><span class="o">.</span><span class="n">Workbooks</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">i_sz_excel_path</span><span class="p">)</span>

        <span class="n">ws_source</span> <span class="o">=</span> <span class="n">wb_source</span><span class="o">.</span><span class="n">Worksheets</span><span class="p">(</span><span class="n">i_sz_ws_name</span><span class="p">)</span>
        <span class="n">ws_source</span><span class="o">.</span><span class="n">PageSetup</span><span class="o">.</span><span class="n">Orientation</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># change orientation to landscape</span>
        <span class="n">ws_source</span><span class="o">.</span><span class="n">Select</span><span class="p">()</span>

        <span class="n">wb_source</span><span class="o">.</span><span class="n">ActiveSheet</span><span class="o">.</span><span class="n">ExportAsFixedFormat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_sz_pdf_path</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">excel</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Quit</span><span class="p">()</span></div>

<div class="viewcode-block" id="download_points"><a class="viewcode-back" href="../app.html#app.download_points">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/download_points&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_points</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports points as PDF.</span>

<span class="sd">    :parameters: points data from *retrieve_points_summary()*</span>
<span class="sd">    :return: *points_senior.pdf* and *points_junior.pdf*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myJson</span> <span class="o">=</span> <span class="n">retrieve_points_summary</span><span class="p">()</span>
    <span class="n">myJunior</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">mySenior</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myJson</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">mySenior</span> <span class="o">=</span> <span class="n">myJson</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="c1"># &lt;dict&gt;</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;j&#39;</span><span class="p">:</span>
            <span class="n">myJunior</span> <span class="o">=</span> <span class="n">myJson</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="c1"># &lt;dict&gt;</span>
    
    <span class="n">myJ</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">myS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myJunior</span><span class="p">:</span>
        <span class="n">myJ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mySenior</span><span class="p">:</span>
        <span class="n">myS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
    <span class="c1">### JUNIOR</span>
    <span class="n">df_J</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">myJunior</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Doctor&#39;</span><span class="p">]</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">&#39;points_junior.xlsx&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;junior&#39;</span><span class="p">)</span>
    
    <span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
    <span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s1">&#39;junior&#39;</span><span class="p">]</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">repeat_columns</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
    
    <span class="c1"># set column width</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:XFD&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>                    
    <span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
    <span class="n">print_excel_worksheet_to_pdf</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">points_junior.xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;junior&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">points_junior.pdf&#39;</span><span class="p">)</span>
    
    <span class="c1">### SENIOR</span>
    <span class="n">df_S</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mySenior</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">df_S</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Doctor&#39;</span><span class="p">]</span>
    <span class="n">df_S</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">writer2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">&#39;points_senior.xlsx&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
    <span class="n">df_S</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;senior&#39;</span><span class="p">)</span>
    
    <span class="n">workbook2</span> <span class="o">=</span> <span class="n">writer2</span><span class="o">.</span><span class="n">book</span>
    <span class="n">worksheet2</span> <span class="o">=</span> <span class="n">writer2</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s1">&#39;senior&#39;</span><span class="p">]</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">repeat_columns</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
    
    <span class="c1"># set column width</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:XFD&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
                                        
    <span class="n">writer2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
    <span class="n">print_excel_worksheet_to_pdf</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">points_senior.xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;senior&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">points_senior.pdf&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;points&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="download_calls"><a class="viewcode-back" href="../app.html#app.download_calls">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/download_calls&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_calls</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports summary as PDF.</span>

<span class="sd">    :parameters: summary data from *retrieve_call_summary()*</span>
<span class="sd">    :return: *summary.pdf* </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myJson</span> <span class="o">=</span> <span class="n">retrieve_call_summary</span><span class="p">()</span>
     
    <span class="n">myJ</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myJson</span><span class="p">:</span>
        <span class="n">myJ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
   
    <span class="n">df_J</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">myJson</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">&#39;summary.xlsx&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;calls&#39;</span><span class="p">)</span>
    
    <span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
    <span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s1">&#39;calls&#39;</span><span class="p">]</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">repeat_columns</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 

    <span class="c1"># Add a header format.</span>
    <span class="n">header_format</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
                        <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;text_wrap&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="mi">1</span>
                    <span class="p">})</span>

    <span class="c1"># set column width</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:XFD&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
                                               
    <span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
    <span class="n">print_excel_worksheet_to_pdf</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">summary.xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;calls&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">summary.pdf&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;calls&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="download_icu_duties"><a class="viewcode-back" href="../app.html#app.download_icu_duties">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/download_icu_duties&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_icu_duties</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports ICU duties roster as PDF.</span>

<span class="sd">    :parameters: data from *retrieve_icu_1_table()* and *retrieve_icu_2_table()*</span>
<span class="sd">    :return: *icu_1.pdf* and *icu_2.pdf*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myJunior</span> <span class="o">=</span> <span class="n">retrieve_icu_1_table</span><span class="p">()</span>
    <span class="n">mySenior</span> <span class="o">=</span> <span class="n">retrieve_icu_2_table</span><span class="p">()</span>
    
    <span class="n">myJ</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">myS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myJunior</span><span class="p">:</span>
        <span class="n">myJ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mySenior</span><span class="p">:</span>
        <span class="n">myS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
    <span class="c1">### icu1</span>
    <span class="n">df_J</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">myJunior</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;Doctor&quot;</span><span class="p">})</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">&#39;icu_1.xlsx&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
    <span class="n">df_J</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;icu1&#39;</span><span class="p">)</span>
    
    <span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
    <span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s1">&#39;icu1&#39;</span><span class="p">]</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">repeat_columns</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
    
    <span class="c1"># set column width</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:XFD&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
                                               
    <span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
    <span class="n">print_excel_worksheet_to_pdf</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">icu_1.xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;icu1&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">icu_1.pdf&#39;</span><span class="p">)</span>
    
    <span class="c1">### icu2</span>
    <span class="n">df_S</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mySenior</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">df_S</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span>
    <span class="n">df_S</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;Doctor&quot;</span><span class="p">})</span>
    <span class="n">df_S</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">writer2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">&#39;icu_2.xlsx&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
    <span class="n">df_S</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;icu2&#39;</span><span class="p">)</span>
    
    <span class="n">workbook2</span> <span class="o">=</span> <span class="n">writer2</span><span class="o">.</span><span class="n">book</span>
    <span class="n">worksheet2</span> <span class="o">=</span> <span class="n">writer2</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s1">&#39;icu2&#39;</span><span class="p">]</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">repeat_columns</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
    
    <span class="c1"># set column width</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;A:A&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">worksheet2</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="s1">&#39;B:XFD&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
                                        
    <span class="n">writer2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    
    <span class="n">print_excel_worksheet_to_pdf</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">icu_2.xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;icu2&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;C:\flask_app</span><span class="se">\\</span><span class="s1">icu_2.pdf&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;icu_duties&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="download_schedules_csv"><a class="viewcode-back" href="../app.html#app.download_schedules_csv">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/download_schedules_csv&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">download_schedules_csv</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports timetable as CSV. </span>

<span class="sd">    :parameters: data from *exportScheduleS()* and *exportScheduleJ()*</span>
<span class="sd">    :return: *scheduleS.xlsx* and *scheduleJ.xlsx*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Download the senior doctor schedule</span>
    <span class="n">senior_schedule</span> <span class="o">=</span> <span class="n">exportScheduleS</span><span class="p">()</span>

    <span class="c1"># Download the junior doctor schedule</span>
    <span class="n">junior_schedule</span> <span class="o">=</span> <span class="n">exportScheduleJ</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;timetable&quot;</span><span class="p">))</span></div>

<span class="c1">### DATABASE ###</span>
<div class="viewcode-block" id="populate_database"><a class="viewcode-back" href="../app.html#app.populate_database">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/populate_database&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">populate_database</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates new schedule. </span>

<span class="sd">    It calls other functions to extract FormSG emails, extract *information_excel.xlsx*, populate database with these data and run LP.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Establish connection to DB</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM InputDate;&quot;&quot;&quot;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">)</span>
    <span class="n">query_date</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">query_start_date</span> <span class="o">=</span> <span class="n">query_date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    
    <span class="n">query_last_date</span> <span class="o">=</span> <span class="n">query_date</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Check and read all sheets from the excel file and insert into DB</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">clash_checker</span> <span class="o">=</span> <span class="n">clashes</span><span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span><span class="n">query_last_date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clash_checker</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">readRoster</span><span class="p">()</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">readtraining</span><span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span><span class="n">query_last_date</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">readDuties</span><span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span><span class="n">query_last_date</span><span class="p">)</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">readpleave</span><span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span><span class="n">query_last_date</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">readPh</span><span class="p">()</span>

            <span class="c1"># TO ALERT FOR EMPTY SHEETS </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">empty_excel</span> <span class="o">=</span> <span class="s1">&#39;Training or duties sheets are empty!&#39;</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;excel_error_2.html&quot;</span><span class="p">,</span> <span class="n">empty_excel</span><span class="o">=</span><span class="n">empty_excel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># return clash_checker, 501 </span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;excel_error.html&quot;</span><span class="p">,</span> <span class="n">clash_checker</span><span class="o">=</span><span class="n">clash_checker</span><span class="p">)</span>

        <span class="n">F</span> <span class="o">=</span> <span class="n">email_json</span><span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span><span class="n">query_last_date</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">402</span>
    
    <span class="c1"># Get relevant data from DB</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Fetch the constraints defined by the user from DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM Constraints;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">constraints_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">doctor_call_daily</span> <span class="o">=</span> <span class="n">constraints_results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">day_off_monthly</span> <span class="o">=</span> <span class="n">constraints_results</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">max_call_month_4</span> <span class="o">=</span> <span class="n">constraints_results</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">max_call_month_5</span> <span class="o">=</span> <span class="n">constraints_results</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

        <span class="c1"># Fetch the doctor&#39;s name, email stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name,email FROM Roster;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">roster_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Drop previous Temp table, then create new Temp table with the doctor&#39;s name as column header</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;DROP TABLE IF EXISTS Temp;&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS Temp(date TEXT PRIMARY KEY);&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Placing the name &amp; email of doctors in lists AND adding doctor&#39;s name to Temp table as header</span>
        <span class="n">doc_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">doc_email_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">roster_results</span><span class="p">:</span>
            <span class="n">doc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">doc_email_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;ALTER TABLE Temp ADD COLUMN &#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39; TEXT;&#39;&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Fetch the Senior doctor&#39;s name stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name,email FROM Roster WHERE type =&#39;S&#39;;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">senior_roster_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Drop previous TempS table, then create new TempS table with the senior doctor&#39;s name as column header</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;DROP TABLE IF EXISTS TempS;&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS TempS(date TEXT PRIMARY KEY);&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Placing the name of senior doctors in a list AND adding doctor&#39;s name to TempS table as header</span>
        <span class="n">senior_doc_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">senior_doc_email_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">senior_roster_results</span><span class="p">:</span>
            <span class="n">senior_doc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">senior_doc_email_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;ALTER TABLE TempS ADD COLUMN &#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39; TEXT;&#39;&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Fetch the Junior doctor&#39;s name stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name,email FROM Roster WHERE type =&#39;J&#39;;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">junior_roster_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Drop previous TempJ table, then create new TempJ table with the junior doctor&#39;s name as column header</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;DROP TABLE IF EXISTS TempJ;&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS TempJ(date TEXT PRIMARY KEY);&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Placing the name of junior doctors in a list AND adding doctor&#39;s name to TempJ table as header</span>
        <span class="n">junior_doc_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">junior_doc_email_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">junior_roster_results</span><span class="p">:</span>
            <span class="n">junior_doc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">junior_doc_email_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;ALTER TABLE TempJ ADD COLUMN &#39;&#39;&#39;</span> <span class="o">+</span> <span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39; TEXT;&#39;&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Fetch the training data stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM Training WHERE start_date &gt;= ? INTERSECT SELECT * FROM Training WHERE start_date &lt;= ? </span>
<span class="s2">        UNION SELECT * FROM Training WHERE end_date &lt;= ? INTERSECT SELECT * FROM Training WHERE end_date &gt;= ?;&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_start_date</span><span class="p">))</span>
        <span class="n">training_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Fetch the duty data stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM Duty WHERE start_date &gt;= ? INTERSECT SELECT * FROM Duty WHERE start_date &lt;= ? </span>
<span class="s2">        UNION SELECT * FROM Duty WHERE end_date &lt;= ? INTERSECT SELECT * FROM Duty WHERE end_date &gt;= ?;&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_start_date</span><span class="p">))</span>
        <span class="n">duty_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Fetch the priority leave data stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM PriorityLeave WHERE start_date &gt;= ? INTERSECT SELECT * FROM PriorityLeave WHERE start_date &lt;= ? </span>
<span class="s2">        UNION SELECT * FROM PriorityLeave WHERE end_date &lt;= ? INTERSECT SELECT * FROM PriorityLeave WHERE end_date &gt;= ?;&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_start_date</span><span class="p">))</span>
        <span class="n">pl_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Fetch the leave application data stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM LeaveApplication WHERE start_date &gt;= ? INTERSECT SELECT * FROM LeaveApplication WHERE start_date &lt;= ? </span>
<span class="s2">        UNION SELECT * FROM LeaveApplication WHERE end_date &lt;= ? INTERSECT SELECT * FROM LeaveApplication WHERE end_date &gt;= ?;&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_start_date</span><span class="p">))</span>
        <span class="n">la_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Fetch the call request data stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM CallRequest WHERE date &gt;= ? AND date &lt;= ?;&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">))</span>
        <span class="n">cr_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">403</span>

    <span class="c1"># Run the LP and get the LP results that are stored in DB</span>
    <span class="c1"># The input for run_lp is from read_excel functions above + days_for_dates_v3 + excel2matrix</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Delete any existing data from ICU1Duty table from DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;DELETE FROM ICU1Duty&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Delete any existing data from ICU2Duty table from DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;DELETE FROM ICU2Duty&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Delete any existing data from CallLP table from DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;DELETE FROM CallLP&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Reset the auto incremental numbers when each month&#39;s schedule is being generated</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;DELETE FROM sqlite_sequence WHERE name = &#39;CallLP&#39;;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Delete any existing data from LeaveLP table from DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;DELETE FROM LeaveLP&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Reset the auto incremental numbers when each month&#39;s schedule is being generated</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;DELETE FROM sqlite_sequence WHERE name = &#39;LeaveLP&#39;;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># LP function runs here to allocate doctors on call</span>
        <span class="n">lp_result</span> <span class="o">=</span> <span class="n">run_lp</span><span class="p">(</span><span class="n">doctor_call_daily</span><span class="p">,</span> <span class="n">day_off_monthly</span><span class="p">,</span> <span class="n">max_call_month_4</span><span class="p">,</span> <span class="n">max_call_month_5</span><span class="p">,</span> <span class="n">query_start_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">doc_list</span><span class="p">,</span> <span class="n">doc_email_list</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

        <span class="c1"># Insert LP results into DB</span>
        <span class="k">for</span> <span class="n">doc</span><span class="p">,</span><span class="n">monthly_activity</span> <span class="ow">in</span> <span class="n">lp_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name FROM Roster where email = ?&quot;&quot;&quot;</span><span class="p">,(</span><span class="n">doc</span><span class="p">,))</span>
            <span class="n">query_result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">doc_name</span> <span class="o">=</span> <span class="n">query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">each_day</span> <span class="ow">in</span> <span class="n">monthly_activity</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">each_day</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">day</span> <span class="o">=</span> <span class="n">check_day</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">each_day</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
                    <span class="n">cr_dict</span> <span class="o">=</span> <span class="n">readCallRequest</span><span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span><span class="n">query_last_date</span><span class="p">)</span>
                    <span class="n">check_ph_eve</span> <span class="o">=</span> <span class="n">check_eveph</span><span class="p">(</span><span class="n">each_day</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">E</span><span class="p">)</span>
                    
                    <span class="c1"># When doctors have sent in FormSG call requests (requests can be want or don&#39;t want calls) and LP assigned them calls</span>
                    <span class="k">if</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cr_dict</span><span class="p">:</span>
                        <span class="n">checked_before_flag</span> <span class="o">=</span> <span class="kc">False</span>     <span class="c1"># Used to ensure &#39;cr&#39; request_types are added into the DB</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">cr_dict</span><span class="p">[</span><span class="n">doc</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            
                            <span class="c1"># When LP assigns doctors a call date</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">each_day</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">checked_before_flag</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                                
                                <span class="c1"># When doctors have requested for call and LP assigns them their requested date</span>
                                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OnCall&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">day</span> <span class="o">==</span> <span class="s1">&#39;Friday&#39;</span><span class="p">:</span>
                                        <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;crF&#39;</span>
                                    <span class="k">elif</span> <span class="n">day</span> <span class="o">==</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">:</span>
                                        <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;crSat&#39;</span>
                                    <span class="k">elif</span> <span class="n">day</span> <span class="o">==</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">:</span>
                                        <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;crSun&#39;</span>
                                    <span class="k">elif</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">E</span><span class="p">:</span>
                                        <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;crPH&#39;</span>
                                    <span class="k">elif</span> <span class="n">check_ph_eve</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                        <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;crpPH&#39;</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cr&#39;</span>
                                    <span class="n">checked_before_flag</span> <span class="o">=</span> <span class="kc">True</span>
                                
                                <span class="c1"># Obtaining the remarks from DB</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">remark</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">remark</span> <span class="o">=</span> <span class="n">cr_dict</span><span class="p">[</span><span class="n">doc</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                            
                            <span class="c1"># When doctors (who submitted FormSG) are neutral about calls on a date, but the LP assigned them a call to that date</span>
                            <span class="k">elif</span> <span class="n">checked_before_flag</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">day</span> <span class="o">==</span> <span class="s1">&#39;Friday&#39;</span><span class="p">:</span>
                                    <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cF&#39;</span>
                                <span class="k">elif</span> <span class="n">day</span> <span class="o">==</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">:</span>
                                    <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cSat&#39;</span>
                                <span class="k">elif</span> <span class="n">day</span> <span class="o">==</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">:</span>
                                    <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cSun&#39;</span>
                                <span class="k">elif</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">E</span><span class="p">:</span>
                                    <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cPH&#39;</span>
                                <span class="k">elif</span> <span class="n">check_ph_eve</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cpPH&#39;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>
                                <span class="n">remark</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                    
                    <span class="c1"># When doctors assigned calls but they did not request for calls</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">day</span> <span class="o">==</span> <span class="s1">&#39;Friday&#39;</span><span class="p">:</span>
                            <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cF&#39;</span>
                        <span class="k">elif</span> <span class="n">day</span> <span class="o">==</span> <span class="s1">&#39;Saturday&#39;</span><span class="p">:</span>
                            <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cSat&#39;</span>
                        <span class="k">elif</span> <span class="n">day</span> <span class="o">==</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">:</span>
                            <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cSun&#39;</span>
                        <span class="k">elif</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">E</span><span class="p">:</span>
                            <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cPH&#39;</span>
                        <span class="k">elif</span> <span class="n">check_ph_eve</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;cpPH&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">request_type</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>
                        <span class="n">remark</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    
                    <span class="c1"># Inserting the data from FormSG into CallLP table in DB</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;INSERT INTO CallLP (email,name,date,request_type,remark) VALUES (?,?,?,?,?);&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="n">doc_name</span><span class="p">,</span><span class="n">each_day</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">request_type</span><span class="p">,</span><span class="n">remark</span><span class="p">))</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Fetch the call LP data stored in DB (call LP data should only contain processed data for the requested schedule month)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM CallLP;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">call_lp_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Populate the LeaveLP table in DB</span>
        <span class="c1"># Update LeaveLP with approved leave applications, update LeaveApplication with rejected applications by adding (Rejected) in the remark column</span>
        <span class="k">for</span> <span class="n">each_leave_row</span> <span class="ow">in</span> <span class="n">la_results</span><span class="p">:</span>
            <span class="n">call_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">training_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">duty_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pl_flag</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Search the CallLP table for any calls that are within the leave application dates</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM CallLP WHERE email = ? AND date &gt;= ? AND date &lt;= ?&quot;&quot;&quot;</span><span class="p">,(</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
            <span class="n">callLP_each_result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="c1"># When the leave application dates are not within the CallLP date for that doctor</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">callLP_each_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">call_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Search the Training table for any trainings that are within the leave application dates</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM Training WHERE email = ? AND start_date &gt;= ? INTERSECT SELECT * FROM Training WHERE email = ? AND start_date &lt;= ? </span>
<span class="s2">            UNION SELECT * FROM Training WHERE email = ? AND end_date &lt;= ? INTERSECT SELECT * FROM Training WHERE email = ? AND end_date &gt;= ?;&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">training_each_result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="c1"># When the leave application dates are not within the Training dates for that doctor</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_each_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">training_flag</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Search the Duty table for any duties that are within the leave application dates</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM Duty WHERE email = ? AND start_date &gt;= ? INTERSECT SELECT * FROM Duty WHERE email = ? AND start_date &lt;= ? </span>
<span class="s2">            UNION SELECT * FROM Duty WHERE email = ? AND end_date &lt;= ? INTERSECT SELECT * FROM Duty WHERE email = ? AND end_date &gt;= ?;&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">duty_each_result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="c1"># When the leave application dates are not within the Duty dates for that doctor</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duty_each_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">duty_flag</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Search the PriorityLeave table for any priority leaves that are within the leave application dates</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM PriorityLeave WHERE email = ? AND start_date &gt;= ? INTERSECT SELECT * FROM PriorityLeave WHERE email = ? AND start_date &lt;= ? </span>
<span class="s2">            UNION SELECT * FROM PriorityLeave WHERE email = ? AND end_date &lt;= ? INTERSECT SELECT * FROM PriorityLeave WHERE email = ? AND end_date &gt;= ?;&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">pl_each_result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="c1"># When the leave application dates are not within the PriorityLeave dates for that doctor</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pl_each_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pl_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Accept the leave application when all flags are True by updating LeaveLP Table in DB</span>
            <span class="k">if</span> <span class="n">call_flag</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">training_flag</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">duty_flag</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">pl_flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;INSERT INTO LeaveLP (email,name,start_date,end_date,duration,leave_type,remark) VALUES (?,?,?,?,?,?,?);&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># Reject those leave application that clash with training/duty/calls/priorityleave by updating LeaveApplication Table remark column with (Rejected) behind any remarks already present</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_remark</span> <span class="o">=</span> <span class="n">each_leave_row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">old_remark</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_remark</span> <span class="o">=</span> <span class="s2">&quot;(Rejected)&quot;</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;UPDATE LeaveApplication SET remark = ? WHERE leave_id = ?;&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">new_remark</span><span class="p">,</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">elif</span> <span class="s2">&quot;(Rejected)&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_remark</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">old_remark</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_remark</span> <span class="o">=</span> <span class="n">old_remark</span> <span class="o">+</span> <span class="s2">&quot; (Rejected)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_remark</span> <span class="o">=</span> <span class="s2">&quot;(Rejected)&quot;</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;UPDATE LeaveApplication SET remark = ? WHERE leave_id = ?;&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">new_remark</span><span class="p">,</span><span class="n">each_leave_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Fetch the leave LP data stored in DB (leave LP data should only contain processed data for the requested schedule month)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM LeaveLP WHERE start_date &gt;= ? INTERSECT SELECT * FROM LeaveLP WHERE start_date &lt;= ? </span>
<span class="s2">        UNION SELECT * FROM LeaveLP WHERE end_date &lt;= ? INTERSECT SELECT * FROM LeaveLP WHERE end_date &gt;= ?;&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_last_date</span><span class="p">,</span> <span class="n">query_start_date</span><span class="p">))</span>
        <span class="n">leave_lp_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">404</span>
    
    <span class="c1"># Return the data in dictionary format to FrontEnd/UI</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Dictionary to store all necessary data to render the main page timetable</span>
        <span class="n">overall_result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">overall_result1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">overall_result2</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Appending all into dictionary with day as key and everything else as values</span>
        <span class="n">sdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>   <span class="c1"># start date</span>
        <span class="n">edate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">query_last_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>   <span class="c1"># end date</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">edate</span> <span class="o">-</span> <span class="n">sdate</span>       <span class="c1"># as timedelta</span>
        <span class="k">for</span> <span class="n">date_diff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">sdate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">date_diff</span><span class="p">)</span>     <span class="c1"># 2020-08-02 (datetime object format)</span>
            <span class="n">display_day</span> <span class="o">=</span> <span class="n">day</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%Y&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">check_day</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="c1"># Sunday 31-12-2020 (string format)</span>

            <span class="c1"># Initialize an sql statement for inserting a row into Temp table</span>
            <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;INSERT INTO Temp(date,&#39;&#39;&#39;</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">doc_list</span><span class="p">:</span>
                <span class="n">sqlstmt</span> <span class="o">+=</span> <span class="n">each</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;,&#39;&#39;&#39;</span>
            <span class="n">sqlstmt</span> <span class="o">=</span> <span class="n">sqlstmt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;) VALUES (&#39;&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">display_day</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,&quot;&quot;&quot;</span>
            
            <span class="c1"># Initialize an sql statement for inserting a row into TempS table</span>
            <span class="n">sqlstmt1</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;INSERT INTO TempS(date,&#39;&#39;&#39;</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">senior_doc_list</span><span class="p">:</span>
                <span class="n">sqlstmt1</span> <span class="o">+=</span> <span class="n">each</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;,&#39;&#39;&#39;</span>
            <span class="n">sqlstmt1</span> <span class="o">=</span> <span class="n">sqlstmt1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;) VALUES (&#39;&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">display_day</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,&quot;&quot;&quot;</span>

            <span class="c1"># Initialize an sql statement for inserting a row into TempJ table</span>
            <span class="n">sqlstmt2</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;INSERT INTO TempJ(date,&#39;&#39;&#39;</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">junior_doc_list</span><span class="p">:</span>
                <span class="n">sqlstmt2</span> <span class="o">+=</span> <span class="n">each</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;,&#39;&#39;&#39;</span>
            <span class="n">sqlstmt2</span> <span class="o">=</span> <span class="n">sqlstmt2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;) VALUES (&#39;&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">display_day</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&#39;,&quot;&quot;&quot;</span>

            <span class="c1"># Insert date into ICU1Duty and ICU2Duty table</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;INSERT INTO ICU1Duty(date) VALUES (?);&quot;&quot;&quot;</span><span class="p">,(</span><span class="n">display_day</span><span class="p">,))</span>    
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;INSERT INTO ICU2Duty(date) VALUES (?);&quot;&quot;&quot;</span><span class="p">,(</span><span class="n">display_day</span><span class="p">,))</span>                      
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="c1"># Check if the date is a weekend or weekday</span>
            <span class="n">weekend_checker</span> <span class="o">=</span> <span class="n">check_weekend</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>    <span class="c1"># True: date is on a weekend; False: date is on a weekday</span>

            <span class="c1"># Check if date is a public holiday (based on public holidays stored in DB)</span>
            <span class="k">if</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">E</span><span class="p">:</span>
                <span class="n">ph_checker</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>   <span class="c1"># Date is a public holiday</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ph_checker</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>  <span class="c1"># Date is not a public holiday</span>

            <span class="c1"># Storing all doctor&#39;s training for schedule month in training dictionary</span>
            <span class="n">training</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">training_results</span><span class="p">:</span>
                <span class="n">startDate</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">endDate</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">doc_name</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">training_name</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">day</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="ow">and</span> <span class="n">day</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">endDate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                    <span class="n">training</span><span class="p">[</span><span class="n">doc_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">training_name</span>
            
            <span class="c1"># Storing all doctor&#39;s duty for schedule month in duty dictionary</span>
            <span class="n">duty</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">duty_results</span><span class="p">:</span>
                <span class="n">startDate</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">endDate</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">doc_name</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">duty_name</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">day</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="ow">and</span> <span class="n">day</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">endDate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                    <span class="n">duty</span><span class="p">[</span><span class="n">doc_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">duty_name</span>
            
            <span class="c1"># Storing all doctor&#39;s priority leave for schedule month in priority leave dictionary</span>
            <span class="n">priority_leave</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">pl_results</span><span class="p">:</span>
                <span class="n">startDate</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">endDate</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">doc_name</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">leave_reason</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">day</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="ow">and</span> <span class="n">day</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">endDate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                    <span class="n">priority_leave</span><span class="p">[</span><span class="n">doc_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">leave_reason</span>
            
            <span class="c1"># Storing all doctor&#39;s calls based on LP for schedule month in call_LP dictionary</span>
            <span class="n">call_LP</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">call_lp_results</span><span class="p">:</span>
                <span class="n">call_date</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">doc_name</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">call_type</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">remark</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">day</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">call_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                    <span class="n">call_LP</span><span class="p">[</span><span class="n">doc_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_type</span><span class="p">,</span><span class="n">remark</span>
            
            <span class="c1"># # Storing all doctor&#39;s leaves based on LP for schedule month in leave_LP dictionary</span>
            <span class="n">leave_LP</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">leave_lp_results</span><span class="p">:</span>
                <span class="n">startDate</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">endDate</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">doc_name</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">leave_type</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">remark</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">day</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="ow">and</span> <span class="n">day</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">endDate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                    <span class="n">leave_LP</span><span class="p">[</span><span class="n">doc_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span><span class="p">,</span><span class="n">leave_type</span><span class="p">,</span><span class="n">remark</span>

            <span class="c1"># Storing each day&#39;s activity by all doctors in one_day_dict</span>
            <span class="n">one_day_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">senior_one_day</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">junior_one_day</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Determine each doctor&#39;s activity based on above dictionaries and collate into 1 dictionary</span>
            <span class="k">for</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">doc_list</span><span class="p">:</span>
                <span class="n">one_doc_dict</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># When the doctor has training on this day</span>
                <span class="k">if</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">training</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Training&quot;</span><span class="p">:</span> <span class="n">training</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]}</span>
                <span class="c1"># When the doctor has duty on this day</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">duty</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Duty&quot;</span><span class="p">:</span> <span class="n">duty</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]}</span>
                <span class="c1"># When the doctor has priority leave on this day</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">priority_leave</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Priority Leave&quot;</span><span class="p">:</span> <span class="n">priority_leave</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]}</span>
                <span class="c1"># When the doctor has call on this day based on LP/request</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">call_LP</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;On-Call&quot;</span><span class="p">:</span> <span class="n">call_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">call_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">1</span><span class="p">]}</span>
                <span class="c1"># When the doctor has approved leave on this day</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">leave_LP</span><span class="p">:</span>
                    <span class="n">leave_converter</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;AnnualLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (AL)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;TrainingLeave(e.g.Courses&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Training)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MC/HospitalisationLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (MC/HL)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ReservistLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Reservist)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;FamilyCareLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Family)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ChildCareLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Child)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MarriageLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Marriage)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MaternityLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Maternity)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;PaternityLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Paternity)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Others&quot;</span><span class="p">:</span> <span class="s2">&quot;Leave (Others)&quot;</span>
                    <span class="p">}</span>
                    <span class="c1"># When the doctor did not submit remarks for leave in FormSG</span>
                    <span class="k">if</span> <span class="n">leave_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_remark</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="c1"># When the doctor has submitted remarks for leave in FormSG</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_remark</span> <span class="o">=</span> <span class="n">leave_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># Know what is the doctor&#39;s type of leave based on FormSG entries</span>
                    <span class="n">act_type</span> <span class="o">=</span> <span class="n">leave_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Split doctor&#39;s on-leave status based on the duration of the leave and type of leave</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;On-Leave&quot;</span><span class="p">:</span> <span class="n">leave_converter</span><span class="p">[</span><span class="n">act_type</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">new_remark</span><span class="p">}</span>

                    <span class="c1">###### Uncomment the below codes if you want to differentiate by duration of leave (AM/PM/Whole Day)</span>
                    <span class="c1"># if leave_LP[each_doc][0] == &quot;AM&quot;:</span>
                    <span class="c1">#     one_doc_dict[each_doc] = {&quot; AM On-Leave&quot;: leave_converter[act_type] + &#39;-&#39; + new_remark}</span>
                    <span class="c1"># elif leave_LP[each_doc][0] == &quot;PM&quot;:</span>
                    <span class="c1">#     one_doc_dict[each_doc] = {&quot;PM On-Leave&quot;: leave_converter[act_type] + &#39;-&#39; + new_remark}</span>
                    <span class="c1"># elif leave_LP[each_doc][0] == &quot;WholeDay&quot;:</span>
                    <span class="c1">#     one_doc_dict[each_doc] = {&quot;Whole Day On-Leave&quot;: leave_converter[act_type] + &#39;-&#39; + new_remark}</span>

                <span class="c1"># When the doctor is not on call/duty/training/leave, and the day is a weekend/public holiday</span>
                <span class="k">elif</span> <span class="n">weekend_checker</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">ph_checker</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Off&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
                <span class="c1"># When the day is a normal working day</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Working&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

                <span class="c1"># Combine all the activity data into 1 single dictionary</span>
                <span class="n">one_day_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span>

            <span class="c1"># Combine one day&#39;s worth of data into 1 overall dictionary</span>
            <span class="n">overall_result</span><span class="p">[</span><span class="n">display_day</span><span class="p">]</span> <span class="o">=</span> <span class="n">one_day_dict</span>

            <span class="c1"># Continuation of creating sql statement to insert values into Temp table</span>
            <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">doc_list</span><span class="p">:</span>
                <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">one_day_dict</span><span class="p">[</span><span class="n">each</span><span class="p">]))</span>
                <span class="n">sqlstmt</span> <span class="o">+=</span> <span class="s1">&#39;&#39;&#39;?,&#39;&#39;&#39;</span>
            <span class="n">sqlstmt</span> <span class="o">=</span> <span class="n">sqlstmt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;);&#39;&#39;&#39;</span>   <span class="c1"># Example: INSERT INTO Temp(date,name,...) VALUES (&#39;2020-08-15&#39;,&#39;training&#39;,...);</span>
            <span class="n">temp_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span>

            <span class="c1"># Executing sql statement to add values into Temp table</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">,</span><span class="n">temp_tuple</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="c1"># Determine each Senior doctor&#39;s activity based on above dictionaries and collate into 1 dictionary</span>
            <span class="k">for</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">senior_doc_list</span><span class="p">:</span>
                <span class="n">one_doc_dict</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># When the doctor has training on this day</span>
                <span class="k">if</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">training</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Training&quot;</span><span class="p">:</span> <span class="n">training</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]}</span>
                <span class="c1"># When the doctor has duty on this day</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">duty</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Duty&quot;</span><span class="p">:</span> <span class="n">duty</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]}</span>
                <span class="c1"># When the doctor has priority leave on this day</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">priority_leave</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Priority Leave&quot;</span><span class="p">:</span> <span class="n">priority_leave</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]}</span>
                <span class="c1"># When the doctor has call on this day based on LP/request</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">call_LP</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;On-Call&quot;</span><span class="p">:</span> <span class="n">call_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">call_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">1</span><span class="p">]}</span>
                <span class="c1"># When the doctor has approved leave on this day</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">leave_LP</span><span class="p">:</span>
                    <span class="n">leave_converter</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;AnnualLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (AL)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;TrainingLeave(e.g.Courses&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Training)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MC/HospitalisationLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (MC/HL)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ReservistLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Reservist)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;FamilyCareLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Family)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ChildCareLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Child)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MarriageLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Marriage)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MaternityLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Maternity)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;PaternityLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Paternity)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Others&quot;</span><span class="p">:</span> <span class="s2">&quot;Leave (Others)&quot;</span>
                    <span class="p">}</span>
                    <span class="c1"># When the doctor did not submit remarks for leave in FormSG</span>
                    <span class="k">if</span> <span class="n">leave_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_remark</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="c1"># When the doctor has submitted remarks for leave in FormSG</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_remark</span> <span class="o">=</span> <span class="n">leave_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># Know what is the doctor&#39;s type of leave based on FormSG entries</span>
                    <span class="n">act_type</span> <span class="o">=</span> <span class="n">leave_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Split doctor&#39;s on-leave status based on the duration of the leave and type of leave</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;On-Leave&quot;</span><span class="p">:</span> <span class="n">leave_converter</span><span class="p">[</span><span class="n">act_type</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">new_remark</span><span class="p">}</span>

                    <span class="c1">###### Uncomment the below codes if you want to differentiate by duration of leave (AM/PM/Whole Day)</span>
                    <span class="c1"># if leave_LP[each_doc][0] == &quot;AM&quot;:</span>
                    <span class="c1">#     one_doc_dict[each_doc] = {&quot; AM On-Leave&quot;: leave_converter[act_type] + &#39;-&#39; + new_remark}</span>
                    <span class="c1"># elif leave_LP[each_doc][0] == &quot;PM&quot;:</span>
                    <span class="c1">#     one_doc_dict[each_doc] = {&quot;PM On-Leave&quot;: leave_converter[act_type] + &#39;-&#39; + new_remark}</span>
                    <span class="c1"># elif leave_LP[each_doc][0] == &quot;WholeDay&quot;:</span>
                    <span class="c1">#     one_doc_dict[each_doc] = {&quot;Whole Day On-Leave&quot;: leave_converter[act_type] + &#39;-&#39; + new_remark}</span>
                    
                <span class="c1"># When the doctor is not on call/duty/training/leave, and the day is a weekend/public holiday</span>
                <span class="k">elif</span> <span class="n">weekend_checker</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">ph_checker</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Off&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
                <span class="c1"># When the day is a normal working day</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Working&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

                <span class="c1"># Combine all the activity data into 1 single dictionary</span>
                <span class="n">senior_one_day</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span>
            
            <span class="c1"># Combine one day&#39;s worth of data into 1 overall dictionary</span>
            <span class="n">overall_result1</span><span class="p">[</span><span class="n">display_day</span><span class="p">]</span> <span class="o">=</span> <span class="n">senior_one_day</span>

            <span class="c1"># Continuation of creating sql statement 1 to insert values into TempS table</span>
            <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">senior_doc_list</span><span class="p">:</span>
                <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">senior_one_day</span><span class="p">[</span><span class="n">each</span><span class="p">]))</span>
                <span class="n">sqlstmt1</span> <span class="o">+=</span> <span class="s1">&#39;&#39;&#39;?,&#39;&#39;&#39;</span>
            <span class="n">sqlstmt1</span> <span class="o">=</span> <span class="n">sqlstmt1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;);&#39;&#39;&#39;</span>   <span class="c1"># Example: INSERT INTO TempS(date,name,...) VALUES (&#39;2020-08-15&#39;,&#39;training&#39;,...);</span>
            <span class="n">temp_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span>

            <span class="c1"># Executing sql statement to add values into TempS table</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt1</span><span class="p">,</span><span class="n">temp_tuple</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="c1"># Determine each Junior doctor&#39;s activity based on above dictionaries and collate into 1 dictionary</span>
            <span class="k">for</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">junior_doc_list</span><span class="p">:</span>
                <span class="n">one_doc_dict</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># When the doctor has training on this day</span>
                <span class="k">if</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">training</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Training&quot;</span><span class="p">:</span> <span class="n">training</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]}</span>
                <span class="c1"># When the doctor has duty on this day</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">duty</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Duty&quot;</span><span class="p">:</span> <span class="n">duty</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]}</span>
                <span class="c1"># When the doctor has priority leave on this day</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">priority_leave</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Priority Leave&quot;</span><span class="p">:</span> <span class="n">priority_leave</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]}</span>
                <span class="c1"># When the doctor has call on this day based on LP/request</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">call_LP</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;On-Call&quot;</span><span class="p">:</span> <span class="n">call_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">call_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">1</span><span class="p">]}</span>
                <span class="c1"># When the doctor has approved leave on this day</span>
                <span class="k">elif</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">leave_LP</span><span class="p">:</span>
                    <span class="n">leave_converter</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;AnnualLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (AL)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;TrainingLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Training)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MC/HospitalisationLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (MC/HL)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ReservistLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Reservist)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;FamilyCareLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Family)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ChildCareLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Child)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MarriageLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Marriage)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MaternityLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Maternity)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;PaternityLeave&quot;</span> <span class="p">:</span> <span class="s2">&quot;Leave (Paternity)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Others&quot;</span><span class="p">:</span> <span class="s2">&quot;Leave (Others)&quot;</span>
                    <span class="p">}</span>
                    <span class="c1"># When the doctor did not submit remarks for leave in FormSG</span>
                    <span class="k">if</span> <span class="n">leave_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">new_remark</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="c1"># When the doctor has submitted remarks for leave in FormSG</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_remark</span> <span class="o">=</span> <span class="n">leave_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># Know what is the doctor&#39;s type of leave based on FormSG entries</span>
                    <span class="n">act_type</span> <span class="o">=</span> <span class="n">leave_LP</span><span class="p">[</span><span class="n">each_doc</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Split doctor&#39;s on-leave status based on the duration of the leave and type of leave</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;On-Leave&quot;</span><span class="p">:</span> <span class="n">leave_converter</span><span class="p">[</span><span class="n">act_type</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">new_remark</span><span class="p">}</span>

                    <span class="c1">###### Uncomment the below codes if you want to differentiate by duration of leave (AM/PM/Whole Day)</span>
                    <span class="c1"># if leave_LP[each_doc][0] == &quot;AM&quot;:</span>
                    <span class="c1">#     one_doc_dict[each_doc] = {&quot; AM On-Leave&quot;: leave_converter[act_type] + &#39;-&#39; + new_remark}</span>
                    <span class="c1"># elif leave_LP[each_doc][0] == &quot;PM&quot;:</span>
                    <span class="c1">#     one_doc_dict[each_doc] = {&quot;PM On-Leave&quot;: leave_converter[act_type] + &#39;-&#39; + new_remark}</span>
                    <span class="c1"># elif leave_LP[each_doc][0] == &quot;WholeDay&quot;:</span>
                    <span class="c1">#     one_doc_dict[each_doc] = {&quot;Whole Day On-Leave&quot;: leave_converter[act_type] + &#39;-&#39; + new_remark}</span>
                    
                <span class="c1"># When the doctor is not on call/duty/training/leave, and the day is a weekend/public holiday</span>
                <span class="k">elif</span> <span class="n">weekend_checker</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span> <span class="ow">or</span> <span class="n">ph_checker</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Off&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
                <span class="c1"># When the day is a normal working day</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Working&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

                <span class="c1"># Combine all the activity data into 1 single dictionary</span>
                <span class="n">junior_one_day</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="n">one_doc_dict</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span>

            <span class="c1"># Combine one day&#39;s worth of data into 1 overall dictionary</span>
            <span class="n">overall_result2</span><span class="p">[</span><span class="n">display_day</span><span class="p">]</span> <span class="o">=</span> <span class="n">junior_one_day</span>

            <span class="c1"># Continuation of creating sql statement 2 to insert values into TempJ table</span>
            <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">junior_doc_list</span><span class="p">:</span>
                <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">junior_one_day</span><span class="p">[</span><span class="n">each</span><span class="p">]))</span>
                <span class="n">sqlstmt2</span> <span class="o">+=</span> <span class="s1">&#39;&#39;&#39;?,&#39;&#39;&#39;</span>
            <span class="n">sqlstmt2</span> <span class="o">=</span> <span class="n">sqlstmt2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;);&#39;&#39;&#39;</span>   <span class="c1"># Example: INSERT INTO TempJ(date,name,...) VALUES (&#39;2020-08-15&#39;,&#39;training&#39;,...);</span>
            <span class="n">temp_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span>

            <span class="c1"># Executing sql statement to add values into TempJ table</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt2</span><span class="p">,</span><span class="n">temp_tuple</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Changing the output to desired format</span>
        <span class="n">new</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">doc_list</span><span class="p">:</span>
            <span class="n">overall_doc_activity</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">overall_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">overall_doc_activity</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span>
            
            <span class="n">new</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_doc_activity</span>
        
        <span class="n">new1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">senior_doc_list</span><span class="p">:</span>
            <span class="n">overall_doc_activity</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">overall_result1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">overall_doc_activity</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span>
            
            <span class="n">new1</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_doc_activity</span>
        
        <span class="n">new2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">each_doc</span> <span class="ow">in</span> <span class="n">junior_doc_list</span><span class="p">:</span>
            <span class="n">overall_doc_activity</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">overall_result2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">overall_doc_activity</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span>
            
            <span class="n">new2</span><span class="p">[</span><span class="n">each_doc</span><span class="p">]</span> <span class="o">=</span> <span class="n">overall_doc_activity</span>
        
        <span class="c1"># Put the dictionaries into dictionary format: {S: Senior doctor dictionary, J: Junior doctor dictionary}</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="n">new1</span><span class="p">,</span><span class="s1">&#39;J&#39;</span><span class="p">:</span><span class="n">new2</span><span class="p">}</span>

        <span class="c1"># Close connection to DB</span>
        <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

        <span class="c1"># returns the necessary data to render schedule</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;timetable&#39;</span><span class="p">))</span>  

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">405</span></div>

<div class="viewcode-block" id="retrieve_timetable"><a class="viewcode-back" href="../app.html#app.retrieve_timetable">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/retrieve_timetable&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">retrieve_timetable</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves timeatable from *TempJ* and *TempS* tables.</span>

<span class="sd">    :parameters: timetable data from *TempJ* and *TempS* tables</span>
<span class="sd">    :return: nested dictionary containing status, doctor, date, type and remarks generated by the LP. </span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;S&quot;: {&quot;Dr Lee&quot;: {&quot;01-05-2021 Saturday&quot;: {&quot;Off&quot;: &quot;&quot;}}}, &quot;J&quot;: {&quot;Dr Ho&quot;: {&quot;01-05-2021 Saturday&quot;: {&quot;Duty&quot;: &quot;ICU 1&quot;}}}}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>

    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name FROM Roster where type = &#39;J&#39;;&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">junior_names</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name FROM Roster where type = &#39;S&#39;;&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">senior_names</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">junior_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">junior_names</span><span class="p">)):</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT date, &quot;&quot;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">junior_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot; FROM TempJ;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">new1</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">new</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">new1</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">activty</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">activity1</span> <span class="o">=</span> <span class="n">activty</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">new</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">activity1</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">junior_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">junior_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>

    <span class="n">senior_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">senior_names</span><span class="p">)):</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT date, &quot;&quot;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">senior_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot; FROM TempS;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">new2</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">new</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">new2</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">activty</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">activity1</span> <span class="o">=</span> <span class="n">activty</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">new</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">activity1</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">senior_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">senior_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
    
    <span class="c1"># Put the dictionaries into dictionary format: {S: Senior doctor dictionary, J: Junior doctor dictionary}</span>
    <span class="n">final</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="n">senior_dict</span><span class="p">,</span><span class="s1">&#39;J&#39;</span><span class="p">:</span><span class="n">junior_dict</span><span class="p">}</span>
    
    <span class="c1"># Close connection to DB</span>
    <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

    <span class="c1"># returns the necessary data to render schedule</span>
    <span class="k">return</span> <span class="n">final</span></div>

<div class="viewcode-block" id="update_timetable_new"><a class="viewcode-back" href="../app.html#app.update_timetable_new">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/update_timetable_new&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_timetable_new</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the changes made in the timetable in **Timetable** page and updates the *TempJ* and *TempS* tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>

    <span class="n">jsdata</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;javascript_data&#39;</span><span class="p">]</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jsdata</span><span class="p">)[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
    <span class="n">doctor</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jsdata</span><span class="p">)[</span><span class="s1">&#39;doctor&#39;</span><span class="p">]</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jsdata</span><span class="p">)[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jsdata</span><span class="p">)[</span><span class="s1">&#39;types&#39;</span><span class="p">]</span>
    <span class="n">remarks</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jsdata</span><span class="p">)[</span><span class="s1">&#39;remarks&#39;</span><span class="p">]</span>

    <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE Temp SET &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">doctor</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot; = ? WHERE date = ?;&quot;&quot;&quot;</span>
    <span class="n">new_variable</span> <span class="o">=</span> <span class="s2">&quot;{&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;:&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">remarks</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;}&quot;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">,</span> <span class="p">(</span><span class="n">new_variable</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;J&#39;</span><span class="p">:</span>
        <span class="c1"># SELECT * from &quot;TempJ&quot;where date=&#39;Thursday 16-07-2020&#39;</span>
        <span class="c1"># UPDATE &quot;TempJ&quot; SET H = &quot;{&#39;Priority Leave&#39;: &#39;NEW&#39;}&quot; WHERE date = &#39;Thursday 16-07-2020&#39;</span>
        <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE TempJ SET &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">doctor</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot; = ? WHERE date = ?;&quot;&quot;&quot;</span>
        <span class="n">new_variable</span> <span class="o">=</span> <span class="s2">&quot;{&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;:&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">remarks</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;}&quot;</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">,</span> <span class="p">(</span><span class="n">new_variable</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
        <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE TempS SET &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">doctor</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot; = ? WHERE date = ?;&quot;&quot;&quot;</span>
        <span class="n">new_variable</span> <span class="o">=</span> <span class="s2">&quot;{&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;:&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">remarks</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;}&quot;</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">,</span> <span class="p">(</span><span class="n">new_variable</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Close connection to DB</span>
    <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;True&quot;</span></div>

<div class="viewcode-block" id="retrieve_constraints"><a class="viewcode-back" href="../app.html#app.retrieve_constraints">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/retrieve_constraints&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">retrieve_constraints</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves specified constraints from *Constraints* table.</span>

<span class="sd">    :parameters: timetable data from *Constraints* table</span>
<span class="sd">    :return: dictionary of constraints name &amp; constraints value.</span>
<span class="sd">    For example: *{&quot;P&quot;: 3, &quot;amSat_clinic_1&quot;: 1, &quot;amSat_clinic_3&quot;: 1}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT * FROM Constraints;&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;doctor_call_daily&#39;</span><span class="p">:</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;day_off_monthly&#39;</span><span class="p">:</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                <span class="s1">&#39;max_call_month_4&#39;</span><span class="p">:</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                <span class="s1">&#39;max_call_month_5&#39;</span><span class="p">:</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
                <span class="s2">&quot;total_call&quot;</span><span class="p">:</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> 
                <span class="s2">&quot;clinic_1&quot;</span><span class="p">:</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span> 
                <span class="s2">&quot;clinic_2&quot;</span><span class="p">:</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">],</span> 
                <span class="s2">&quot;amSat_clinic_4&quot;</span><span class="p">:</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">],</span> 
                <span class="s2">&quot;amSat_clinic_1&quot;</span><span class="p">:</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span> 
                <span class="s2">&quot;amSat_clinic_3&quot;</span><span class="p">:</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">],</span> 
                <span class="s2">&quot;P&quot;</span><span class="p">:</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="edit_constraints"><a class="viewcode-back" href="../app.html#app.edit_constraints">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/edit_constraints&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">edit_constraints</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the changes made in the constraints in the **Home** page and updates the *Constraints* tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Obtain user input for schedule start date and end date</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">query_start_date</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span>        <span class="c1"># Must be in this format of dd-mm-yyyy</span>
        <span class="n">query_last_date</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span>           <span class="c1"># Must be in this format of dd-mm-yyyy</span>
        <span class="n">query_request_month</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;selected_month&#39;</span><span class="p">]</span> 

        <span class="c1"># If not must use the below 2 lines to convert the format</span>
        <span class="n">query_start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">query_last_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">query_last_date</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Establish connection to DB</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>    

        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;DELETE FROM InputDate;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span> 

        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;INSERT INTO InputDate (start_date,end_date,month) VALUES (?,?,?);&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">query_start_date</span><span class="p">,</span><span class="n">query_last_date</span><span class="p">,</span><span class="n">query_request_month</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span> 

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">401</span>

    <span class="c1"># Obtain user input values from front-end UI to save into DB, also create connection to DB</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">doctor_call_daily</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;doctor_call_daily&#39;</span><span class="p">]</span>
        <span class="n">day_off_monthly</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;day_off_monthly&#39;</span><span class="p">]</span>
        <span class="n">max_call_month_4</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;max_call_month_4&#39;</span><span class="p">]</span>
        <span class="n">max_call_month_5</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;max_call_month_5&#39;</span><span class="p">]</span>
        <span class="n">total_call</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;total_call&#39;</span><span class="p">]</span>
        <span class="n">clinic_1</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;clinic_1&#39;</span><span class="p">]</span>
        <span class="n">clinic_2</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;clinic_2&#39;</span><span class="p">]</span>
        <span class="n">amSat_clinic_4</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;amSat_clinic_4&#39;</span><span class="p">]</span>
        <span class="n">amSat_clinic_1</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;amSat_clinic_1&#39;</span><span class="p">]</span>
        <span class="n">amSat_clinic_3</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;amSat_clinic_3&#39;</span><span class="p">]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>

        <span class="c1"># Establish connection to DB</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">402</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Empty the Constraints Table in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;DELETE FROM Constraints&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Insert edited values into database and commit to database</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;INSERT OR IGNORE INTO Constraints</span>
<span class="s2">        (constraint_id, doctor_call_daily, day_off_monthly, max_call_month_four, max_call_month_five, total_call, </span>
<span class="s2">        clinic_1, clinic_2, amSat_clinic_4, amSat_clinic_1, amSat_clinic_3, P) </span>
<span class="s2">        VALUES (1, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);&quot;&quot;&quot;</span><span class="p">,</span> 
        <span class="p">(</span><span class="n">doctor_call_daily</span><span class="p">,</span><span class="n">day_off_monthly</span><span class="p">,</span><span class="n">max_call_month_4</span><span class="p">,</span><span class="n">max_call_month_5</span><span class="p">,</span><span class="n">total_call</span><span class="p">,</span> 
        <span class="n">clinic_1</span><span class="p">,</span> <span class="n">clinic_2</span><span class="p">,</span> <span class="n">amSat_clinic_4</span><span class="p">,</span> <span class="n">amSat_clinic_1</span><span class="p">,</span> <span class="n">amSat_clinic_3</span><span class="p">,</span> <span class="n">P</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Close connection to DB</span>
        <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

        <span class="c1"># Returns True when saved successfully into DB</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;populate_database&quot;</span><span class="p">))</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">403</span></div>

<div class="viewcode-block" id="check_constraints"><a class="viewcode-back" href="../app.html#app.check_constraints">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/check_constraints&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check_constraints</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validates timetable against specified constraints.</span>

<span class="sd">    :parameters: *is_constraint_met()* </span>
<span class="sd">    :return: dictionary containing date and list of unmet constraints. </span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;01-05-2021 Saturday&quot;: [&quot;total call&quot;, &quot;clinic 1&quot;, &quot;clinic 2&quot;]}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Establish connection to DB</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM InputDate;&quot;&quot;&quot;</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">)</span>
    <span class="n">query_date</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">query_date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">query_date</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Close connection to DB</span>
    <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

    <span class="n">checking</span> <span class="o">=</span> <span class="n">is_constraint_met</span><span class="p">(</span><span class="s1">&#39;Temp&#39;</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">checking</span></div>

<div class="viewcode-block" id="retrieve_call_summary"><a class="viewcode-back" href="../app.html#app.retrieve_call_summary">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/retrieve_call_summary&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">retrieve_call_summary</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the number of doctors on call, leave and duty. </span>

<span class="sd">    :parameters: timetable data from *TempS* and *TempJ* tables </span>
<span class="sd">    :return: nested dictionary containing date, summary name and summary value.</span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;01-05-2021 Saturday&quot;: {&quot;P&quot;: 0,&quot;amSat Clinic 1&quot;: 0,&quot;amSat Clinic 3&quot;: 0}}*</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Obtain user input and create connection to DB</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Establish connection to DB</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
        <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM InputDate;&quot;&quot;&quot;</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">)</span>
        <span class="n">query_date</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">query_date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">query_date</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">401</span>

    <span class="c1"># Calculate the month&#39;s call summary and return to UI</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Manipulating the dates for the function to work</span>
        <span class="n">sdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>   <span class="c1"># start date</span>
        <span class="n">edate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>   <span class="c1"># end date</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">edate</span> <span class="o">-</span> <span class="n">sdate</span>       <span class="c1"># as timedelta</span>

        <span class="c1"># Dictionary to store the month&#39;s call summary</span>
        <span class="n">overall_summary</span> <span class="o">=</span> <span class="p">{}</span>
     
        <span class="c1"># Creating a loop to check the calls/duties/working for each day</span>
        <span class="k">for</span> <span class="n">date_diff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">sdate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">date_diff</span><span class="p">)</span>     <span class="c1"># 2020-08-02 (datetime object format)</span>
            <span class="n">display_day</span> <span class="o">=</span> <span class="n">day</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%Y&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">check_day</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="c1"># Sunday 31-12-2020 (string format)</span>
        
            <span class="c1"># Retrieve from DB each day&#39;s schedule</span>
            <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM TempS WHERE date = ?;&quot;&quot;&quot;</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">,(</span><span class="n">display_day</span><span class="p">,))</span>
            <span class="n">constraints_result_S</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

            <span class="c1"># Retrieve from DB each day&#39;s schedule</span>
            <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM TempJ WHERE date = ?;&quot;&quot;&quot;</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">,(</span><span class="n">display_day</span><span class="p">,))</span>
            <span class="n">constraints_result_J</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
       
            <span class="c1"># Counters to record the number of calls/duties/working for each day assigned</span>
            <span class="n">counter_clinic1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_clinic2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_amsatclinic1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_amsatclinic3</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_amsatclinic4</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_totalcall</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_total</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Counting the calls/duties/working from all doctors for each day</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">constraints_result_S</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">str_element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="n">dict_element</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">str_element</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">dict_element</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;amSat Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_amsatclinic1</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;amSat Clinic 3&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_amsatclinic3</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;amSat Clinic 4&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_amsatclinic4</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic1</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 2&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic2</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;P&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_p</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;On-Call&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">counter_totalcall</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;AM On-Leave&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;PM On-Leave&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;Working&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">counter_total</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s1">&#39;PM On-Leave&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PM On-Leave&#39;</span><span class="p">)</span>
            
            <span class="c1"># Counting the calls/duties/working from all doctors for each day</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">constraints_result_J</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">str_element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="n">dict_element</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">str_element</span><span class="p">)</span>
  
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">dict_element</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;amSat Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_amsatclinic1</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;amSat Clinic 3&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_amsatclinic3</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;amSat Clinic 4&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_amsatclinic4</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic1</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 2&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic2</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;P&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_p</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;On-Call&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">counter_totalcall</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;AM On-Leave&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;PM On-Leave&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;Working&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">counter_total</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Placing each day&#39;s call summary into a dictionary format</span>
            <span class="n">overall_summary</span><span class="p">[</span><span class="n">display_day</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;total&quot;</span> <span class="p">:</span> <span class="n">counter_total</span><span class="p">,</span>
                <span class="s2">&quot;total call&quot;</span> <span class="p">:</span> <span class="n">counter_totalcall</span><span class="p">,</span>
                <span class="s2">&quot;clinic 1&quot;</span> <span class="p">:</span> <span class="n">counter_clinic1</span><span class="p">,</span>
                <span class="s2">&quot;clinic 2&quot;</span> <span class="p">:</span> <span class="n">counter_clinic2</span><span class="p">,</span>
                <span class="s2">&quot;amSat Clinic 1&quot;</span> <span class="p">:</span> <span class="n">counter_amsatclinic1</span><span class="p">,</span>
                <span class="s2">&quot;amSat Clinic 3&quot;</span> <span class="p">:</span> <span class="n">counter_amsatclinic3</span><span class="p">,</span>
                <span class="s2">&quot;amSat Clinic 4&quot;</span> <span class="p">:</span> <span class="n">counter_amsatclinic4</span><span class="p">,</span>
                <span class="s2">&quot;P&quot;</span> <span class="p">:</span> <span class="n">counter_p</span>
            <span class="p">}</span>

        <span class="c1"># Close connection to DB</span>
        <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

        <span class="c1"># Return the month&#39;s call summary to UI</span>
        <span class="k">return</span> <span class="n">overall_summary</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">402</span></div>

<div class="viewcode-block" id="retrieve_icu_1_table"><a class="viewcode-back" href="../app.html#app.retrieve_icu_1_table">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/retrieve_icu_1_table&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">retrieve_icu_1_table</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the list of doctors assigned to ICU1 in the month.</span>

<span class="sd">    :parameters: timetable data from *TempS* and *TempJ* tables </span>
<span class="sd">    :return: dictionary containing date and doctor.</span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;01-05-2021 Saturday&quot;: &quot;Dr Lee&quot;, &quot;02-05-2021 Sunday&quot;: &quot;Dr Ho&quot;}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name, date FROM ICU1Duty;&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

    <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">final</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">return</span> <span class="n">final</span></div>

<div class="viewcode-block" id="retrieve_icu_2_table"><a class="viewcode-back" href="../app.html#app.retrieve_icu_2_table">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/retrieve_icu_2_table&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">retrieve_icu_2_table</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the list of doctors assigned to ICU2 in the month.</span>

<span class="sd">    :parameters: timetable data from *TempS* and *TempJ* tables </span>
<span class="sd">    :return: dictionary containing date and doctor.</span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;01-05-2021 Saturday&quot;: &quot;Dr Lee&quot;, &quot;02-05-2021 Sunday&quot;: &quot;Dr Ho&quot;}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name, date FROM ICU2Duty;&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

    <span class="n">final</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">final</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">return</span> <span class="n">final</span></div>

<div class="viewcode-block" id="update_icu_table"><a class="viewcode-back" href="../app.html#app.update_icu_table">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/update_icu_table&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_icu_table</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the changes made in **ICU Duties** page and updates the *ICU1Duty* and *ICU2Duty* tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jsdata</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;javascript_data&#39;</span><span class="p">]</span>
    <span class="n">cell_id</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jsdata</span><span class="p">)[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">cell_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">cell_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">doctor</span> <span class="o">=</span> <span class="n">cell_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># SELECT * from &quot;ICU1Duty&quot;</span>
    <span class="c1"># INSERT OR REPLACE INTO ICU1Duty (name, date) VALUES (&#39;hello&#39;, &#39;Thursday 16-07-2020&#39;);</span>
    <span class="c1"># UPDATE &quot;ICU1Duty&quot; SET name = &quot;hey&quot; WHERE date = &#39;Thursday 16-07-2020&#39;</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
        <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE ICU1Duty SET name = ? WHERE date = ?;&quot;&quot;&quot;</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">,</span> <span class="p">(</span><span class="n">doctor</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;UPDATE ICU2Duty SET name = ? WHERE date = ?;&quot;&quot;&quot;</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">,</span> <span class="p">(</span><span class="n">doctor</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Close connection to DB</span>
    <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

    <span class="c1"># Returns either True or constraints that are not met in the form: {date:[constraint1,constraint2],date:[constraint1],...}</span>
    <span class="k">return</span> <span class="s2">&quot;True&quot;</span></div>

<div class="viewcode-block" id="retrieve_points_summary"><a class="viewcode-back" href="../app.html#app.retrieve_points_summary">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/retrieve_points_summary&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">retrieve_points_summary</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the list of doctors and points obtained from being on call and duty.</span>
<span class="sd">    </span>
<span class="sd">    :parameters: timetable data from *TempS* and *TempJ* tables </span>
<span class="sd">    :return: nested dictionary containing status, doctor, points name and points value.</span>
<span class="sd">    For example:</span>
<span class="sd">    *{&quot;S&quot;:{&quot;Dr Lee&quot;:{&quot;Clinic 1&quot;:0, &quot;Clinic 2&quot;:0, &quot;Clinic 3&quot;:0}}, &quot;J&quot;:{&quot;Dr Ho&quot;:{&quot;Clinic 1&quot;:0, &quot;Clinic 2&quot;:0, &quot;Clinic 3&quot;:0}}}*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create connection to DB and obtain the request month from UI</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Establish connection to DB &amp; retrieve request month</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
        <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT * FROM InputDate;&quot;&quot;&quot;</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">)</span>
        <span class="n">query_date</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">request_month</span> <span class="o">=</span> <span class="n">query_date</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">month_num</span> <span class="o">=</span> <span class="n">check_month_num</span><span class="p">(</span><span class="n">request_month</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">401</span>

    <span class="c1"># Calculate the month&#39;s point summary for all doctors and return to UI</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Fetch the Senior doctor&#39;s name stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name FROM Roster WHERE type =&#39;S&#39;;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">senior_roster_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Dictionary to store the scheduled month&#39;s point summary for senior doctors</span>
        <span class="n">senior_summary</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Query TempS table for each doctor&#39;s schedule</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">senior_roster_results</span><span class="p">:</span>
            <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot; FROM TempS;&quot;&quot;&quot;</span>   <span class="c1">#each[0] refers to the doctor&#39;s name</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">)</span>
            <span class="n">constraints_result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="c1"># Counters to record the number of calls/duties/leave for each day assigned</span>
            <span class="n">counter_wd</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_fri</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_sat</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_sun</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_preph</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_ph</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_satsunam</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_leave</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_clinic1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_clinic2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_clinic3</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_clinic4</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_duty</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">constraints_result</span><span class="p">:</span>
                <span class="n">str_element</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="n">dict_element</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">str_element</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">dict_element</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;c-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;cr-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_wd</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cF-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crF-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_fri</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cSat-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crSat-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_sat</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cSun-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crSun-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_sun</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cpPH-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crpPH-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_preph</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cPH-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crPH-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_ph</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;amSat Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSat Clinic 2&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSat Clinic 3&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSat Clinic 4&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_satsunam</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;amSun Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSun Clinic 2&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSun Clinic 3&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSun Clinic 4&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_satsunam</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic1</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 2&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic2</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 3&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic3</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 4&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic4</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;AM Leave&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;PM Leave&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Whole Leave&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Priority Leave&#39;</span><span class="p">:</span>
                        <span class="n">counter_leave</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Duty&#39;</span><span class="p">:</span>
                        <span class="n">counter_duty</span> <span class="o">+=</span> <span class="mi">1</span>
            
            
            <span class="c1"># Tabulating the total points for calls and duties</span>
            <span class="n">points_fri</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">counter_fri</span>
            <span class="n">points_sat</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">counter_sat</span>
            <span class="n">points_sun</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">counter_sun</span>
            <span class="n">points_preph</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">counter_preph</span>
            <span class="n">points_ph</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">counter_ph</span>
            <span class="n">points_satsunam</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">counter_satsunam</span>
            <span class="n">month_call_points</span> <span class="o">=</span> <span class="n">counter_wd</span> <span class="o">+</span> <span class="n">points_fri</span> <span class="o">+</span> <span class="n">points_sat</span> <span class="o">+</span> <span class="n">points_sun</span> <span class="o">+</span> <span class="n">points_preph</span> <span class="o">+</span> <span class="n">points_ph</span>
            <span class="n">month_calls</span> <span class="o">=</span> <span class="n">counter_wd</span> <span class="o">+</span> <span class="n">counter_fri</span> <span class="o">+</span> <span class="n">counter_sat</span> <span class="o">+</span> <span class="n">counter_sun</span> <span class="o">+</span> <span class="n">counter_preph</span> <span class="o">+</span> <span class="n">counter_ph</span>

            <span class="c1"># Placing each day&#39;s call summary into a dictionary format</span>
            <span class="n">senior_summary</span><span class="p">[</span><span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Month calls&quot;</span> <span class="p">:</span> <span class="n">month_calls</span><span class="p">,</span>
                <span class="s2">&quot;Month call points&quot;</span> <span class="p">:</span> <span class="n">month_call_points</span><span class="p">,</span>
                <span class="s2">&quot;WD&quot;</span> <span class="p">:</span> <span class="n">counter_wd</span><span class="p">,</span>
                <span class="s2">&quot;Fri&quot;</span> <span class="p">:</span> <span class="n">points_fri</span><span class="p">,</span>
                <span class="s2">&quot;Sat&quot;</span> <span class="p">:</span> <span class="n">points_sat</span><span class="p">,</span>
                <span class="s2">&quot;Sun&quot;</span> <span class="p">:</span> <span class="n">points_sun</span><span class="p">,</span>
                <span class="s2">&quot;Pre-PH&quot;</span> <span class="p">:</span> <span class="n">points_preph</span><span class="p">,</span>
                <span class="s2">&quot;PH&quot;</span> <span class="p">:</span> <span class="n">points_ph</span><span class="p">,</span>
                <span class="s2">&quot;Sat/Sun AM&quot;</span> <span class="p">:</span> <span class="n">points_satsunam</span><span class="p">,</span>
                <span class="s2">&quot;Leave&quot;</span> <span class="p">:</span> <span class="n">counter_leave</span><span class="p">,</span>
                <span class="s2">&quot;Clinic 1&quot;</span> <span class="p">:</span> <span class="n">counter_clinic1</span><span class="p">,</span>
                <span class="s2">&quot;Clinic 2&quot;</span> <span class="p">:</span> <span class="n">counter_clinic2</span><span class="p">,</span>
                <span class="s2">&quot;Clinic 3&quot;</span> <span class="p">:</span> <span class="n">counter_clinic3</span><span class="p">,</span>
                <span class="s2">&quot;Clinic 4&quot;</span> <span class="p">:</span> <span class="n">counter_clinic4</span><span class="p">,</span>
                <span class="s2">&quot;Duties&quot;</span> <span class="p">:</span> <span class="n">counter_duty</span>
            <span class="p">}</span>

        <span class="c1"># Fetch the Junior doctor&#39;s name stored in DB</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT name FROM Roster WHERE type =&#39;J&#39;;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">junior_roster_results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Dictionary to store the scheduled month&#39;s point summary for junior doctors</span>
        <span class="n">junior_summary</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Query TempJ table for each doctor&#39;s schedule</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">junior_roster_results</span><span class="p">:</span>
            <span class="n">sqlstmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT &quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot; FROM TempJ;&quot;&quot;&quot;</span>   <span class="c1">#each[0] refers to the doctor&#39;s name</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlstmt</span><span class="p">)</span>
            <span class="n">constraints_result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="c1"># Counters to record the number of calls/duties/leave for each day assigned</span>
            <span class="n">counter_wd</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_fri</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_sat</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_sun</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_preph</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_ph</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_satsunam</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_leave</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_clinic1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_clinic2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_clinic3</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_clinic4</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter_duty</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Counting the calls/duties/leave from all doctors for each day</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">constraints_result</span><span class="p">:</span>
                <span class="n">str_element</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="n">dict_element</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">str_element</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">dict_element</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;c-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;cr-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_wd</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cF-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crF-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_fri</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cSat-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crSat-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_sat</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cSun-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crSun-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_sun</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cpPH-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crpPH-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_preph</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;cPH-&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;crPH-&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_ph</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;amSat Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSat Clinic 2&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSat Clinic 3&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSat Clinic 4&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_satsunam</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;amSun Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSun Clinic 2&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSun Clinic 3&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;amSun Clinic 4&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_satsunam</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 1&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic1</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 2&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic2</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 3&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic3</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Clinic 4&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">counter_clinic4</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;AM Leave&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;PM Leave&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Whole Leave&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Priority Leave&#39;</span><span class="p">:</span>
                        <span class="n">counter_leave</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Duty&#39;</span><span class="p">:</span>
                        <span class="n">counter_duty</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Tabulating the total points for calls and duties</span>
            <span class="n">points_fri</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">counter_fri</span>
            <span class="n">points_sat</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">counter_sat</span>
            <span class="n">points_sun</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">counter_sun</span>
            <span class="n">points_preph</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">counter_preph</span>
            <span class="n">points_ph</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">counter_ph</span>
            <span class="n">points_satsunam</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">counter_satsunam</span>
            <span class="n">month_call_points</span> <span class="o">=</span> <span class="n">counter_wd</span> <span class="o">+</span> <span class="n">points_fri</span> <span class="o">+</span> <span class="n">points_sat</span> <span class="o">+</span> <span class="n">points_sun</span> <span class="o">+</span> <span class="n">points_preph</span> <span class="o">+</span> <span class="n">points_ph</span>
            <span class="n">month_calls</span> <span class="o">=</span> <span class="n">counter_wd</span> <span class="o">+</span> <span class="n">counter_fri</span> <span class="o">+</span> <span class="n">counter_sat</span> <span class="o">+</span> <span class="n">counter_sun</span> <span class="o">+</span> <span class="n">counter_preph</span> <span class="o">+</span> <span class="n">counter_ph</span>

            <span class="c1"># Placing each day&#39;s call summary into a dictionary format</span>
            <span class="n">junior_summary</span><span class="p">[</span><span class="n">each</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Month calls&quot;</span> <span class="p">:</span> <span class="n">month_calls</span><span class="p">,</span>
                <span class="s2">&quot;Month call points&quot;</span> <span class="p">:</span> <span class="n">month_call_points</span><span class="p">,</span>
                <span class="s2">&quot;WD&quot;</span> <span class="p">:</span> <span class="n">counter_wd</span><span class="p">,</span>
                <span class="s2">&quot;Fri&quot;</span> <span class="p">:</span> <span class="n">points_fri</span><span class="p">,</span>
                <span class="s2">&quot;Sat&quot;</span> <span class="p">:</span> <span class="n">points_sat</span><span class="p">,</span>
                <span class="s2">&quot;Sun&quot;</span> <span class="p">:</span> <span class="n">points_sun</span><span class="p">,</span>
                <span class="s2">&quot;Pre-PH&quot;</span> <span class="p">:</span> <span class="n">points_preph</span><span class="p">,</span>
                <span class="s2">&quot;PH&quot;</span> <span class="p">:</span> <span class="n">points_ph</span><span class="p">,</span>
                <span class="s2">&quot;Sat/Sun AM&quot;</span> <span class="p">:</span> <span class="n">points_satsunam</span><span class="p">,</span>
                <span class="s2">&quot;Leave&quot;</span> <span class="p">:</span> <span class="n">counter_leave</span><span class="p">,</span>
                <span class="s2">&quot;Clinic 1&quot;</span> <span class="p">:</span> <span class="n">counter_clinic1</span><span class="p">,</span>
                <span class="s2">&quot;Clinic 2&quot;</span> <span class="p">:</span> <span class="n">counter_clinic2</span><span class="p">,</span>
                <span class="s2">&quot;Clinic 3&quot;</span> <span class="p">:</span> <span class="n">counter_clinic3</span><span class="p">,</span>
                <span class="s2">&quot;Clinic 4&quot;</span> <span class="p">:</span> <span class="n">counter_clinic4</span><span class="p">,</span>
                <span class="s2">&quot;Duties&quot;</span> <span class="p">:</span> <span class="n">counter_duty</span>
            <span class="p">}</span>

        <span class="c1"># Place the 2 points summary dictionaries into a single dictionary</span>
        <span class="n">overall_summary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">senior_summary</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="n">junior_summary</span><span class="p">}</span>

        <span class="c1"># Close connection to DB</span>
        <span class="n">close_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>

        <span class="c1"># Return the month&#39;s call summary to UI</span>
        <span class="k">return</span> <span class="n">overall_summary</span>
    
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="mi">402</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Avante.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>